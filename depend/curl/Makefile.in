LIBRARY_NAME = libcurl.a

SRCFILES = $(wildcard lib/*.c lib/vauth/*.c lib/vtls/*.c)
OBJFILES = $(SRCFILES:%.c=%.o)

CFLAGS += -pipe -fPIC -fno-strict-aliasing -fstack-protector -Iinclude -Ilib -DBUILDING_LIBCURL=1 -DCURL_STATICLIB=1

ifndef NDEBUG
CFLAGS += -g -D_DEBUG=1 -DDEBUG=1 -DDEBUGBUILD=1
else
CFLAGS += -DNDEBUG=1 -O2
endif

ifdef ARCH64
CFLAGS += -DSIZEOF_SIZE_T="8" -DSIZEOF_LONG="8" -DSIZEOF_TIME_T="8" -DRECV_TYPE_RETV="ssize_t" -DSEND_TYPE_RETV="ssize_t" -DGETHOSTNAME_TYPE_ARG2="size_t"
else
CFLAGS += -D_FILE_OFFSET_BITS="64" -DSIZEOF_SIZE_T="4" -DSIZEOF_LONG="4" -DSIZEOF_TIME_T="4" -DRECV_TYPE_RETV="int" -DSEND_TYPE_RETV="int" -DGETHOSTNAME_TYPE_ARG2="unsigned int"
endif

ifdef CURL_OPENSSL
CFLAGS += -I"../../openssl/include" \
-DUSE_OPENSSL="1" \
-DHAVE_LIBSSL="1" \
-DHAVE_OPENSSL_X509_H="1" \
-DHAVE_OPENSSL_RSA_H="1" \
-DHAVE_OPENSSL_CRYPTO_H="1" \
-DHAVE_OPENSSL_PEM_H="1" \
-DHAVE_OPENSSL_SSL_H="1" \
-DHAVE_OPENSSL_ERR_H="1" \
-DHAVE_OPENSSL_ENGINE_H="1" \
-DHAVE_ENGINE_LOAD_BUILTIN_ENGINES="1" \
-DHAVE_SSL_GET_SHUTDOWN="1" \
-DHAVE_OPENSSL_SRP="1" \
-DNTLM_WB_ENABLED="1" \
-DNTLM_WB_FILE="\"/usr/bin/ntlm_auth\"" \
-DUSE_TLS_SRP="1"
endif

CFLAGS += -DCURL_DISABLE_LDAP="1" \
-DCURL_DISABLE_LDAPS="1" \
-DCURL_DISABLE_RTSP="1" \
-DCURL_DISABLE_DICT="1" \
-DCURL_DISABLE_TELNET="1" \
-DCURL_DISABLE_POP3="1" \
-DCURL_DISABLE_IMAP="1" \
-DCURL_DISABLE_SMB="1" \
-DCURL_DISABLE_SMTP="1" \
-DCURL_DISABLE_GOPHER="1" \
-DCURL_DISABLE_VERBOSE_STRINGS="1"

CFLAGS += -DVERSION="\"-\"" \
-DOS="\"universal\"" \
-DSTDC_HEADERS="1" \
-DHAVE_SYS_TYPES_H="1" \
-DHAVE_SYS_STAT_H="1" \
-DHAVE_STDLIB_H="1" \
-DHAVE_STRING_H="1" \
-DHAVE_MEMORY_H="1" \
-DHAVE_STRINGS_H="1" \
-DHAVE_INTTYPES_H="1" \
-DHAVE_STDINT_H="1" \
-DHAVE_UNISTD_H="1" \
-DHAVE_DLFCN_H="1" \
-DTIME_WITH_SYS_TIME="1" \
-DHAVE_SYS_TIME_H="1" \
-DHAVE_TIME_H="1" \
-DHAVE_CLOCK_GETTIME_MONOTONIC="1" \
-DHAVE_ZLIB_H="1" \
-DHAVE_LIBZ="1" \
-DHAVE_SOCKADDR_IN6_SIN6_SCOPE_ID="1" \
-DHAVE_MALLOC_H="1" \
-DHAVE_SYS_SELECT_H="1" \
-DHAVE_SYS_SOCKET_H="1" \
-DHAVE_SYS_IOCTL_H="1" \
-DHAVE_SYS_UIO_H="1" \
-DHAVE_ASSERT_H="1" \
-DHAVE_LIMITS_H="1" \
-DHAVE_ARPA_INET_H="1" \
-DHAVE_NET_IF_H="1" \
-DHAVE_NETINET_IN_H="1" \
-DHAVE_SYS_UN_H="1" \
-DHAVE_NETINET_TCP_H="1" \
-DHAVE_NETDB_H="1" \
-DHAVE_SYS_PARAM_H="1" \
-DHAVE_TERMIOS_H="1" \
-DHAVE_TERMIO_H="1" \
-DHAVE_FCNTL_H="1" \
-DHAVE_ALLOCA_H="1" \
-DHAVE_PWD_H="1" \
-DHAVE_UTIME_H="1" \
-DHAVE_SYS_POLL_H="1" \
-DHAVE_POLL_H="1" \
-DHAVE_SYS_RESOURCE_H="1" \
-DHAVE_LIBGEN_H="1" \
-DHAVE_LOCALE_H="1" \
-DHAVE_ERRNO_H="1" \
-DHAVE_STDBOOL_H="1" \
-DHAVE_ARPA_TFTP_H="1" \
-DHAVE_SYS_WAIT_H="1" \
-DHAVE_SETJMP_H="1" \
-DHAVE_VARIADIC_MACROS_C99="1" \
-DHAVE_VARIADIC_MACROS_GCC="1" \
-DHAVE_STRUCT_TIMEVAL="1" \
-DSIZEOF_INT="4" \
-DSIZEOF_SHORT="2" \
-DSIZEOF_OFF_T="8" \
-DSIZEOF_CURL_OFF_T="8" \
-DHAVE_LONGLONG="1" \
-DHAVE_LL="1" \
-DHAVE_BOOL_T="1" \
-DCURL_PULL_SYS_TYPES_H="1" \
-DCURL_PULL_SYS_SOCKET_H="1" \
-DCURL_TYPEOF_CURL_SOCKLEN_T="socklen_t" \
-DCURL_SIZEOF_CURL_SOCKLEN_T="4" \
-DHAVE_STRUCT_SOCKADDR_STORAGE="1" \
-DHAVE_SIG_ATOMIC_T="1" \
-DRETSIGTYPE="void" \
-DSELECT_TYPE_ARG1="int" \
-DSELECT_TYPE_ARG234="fd_set *" \
-DSELECT_TYPE_RETV="int" \
-DSELECT_QUAL_ARG5="" \
-DSELECT_TYPE_ARG5="struct timeval *" \
-DHAVE_SELECT="1" \
-DRECV_TYPE_ARG1="int" \
-DRECV_TYPE_ARG2="void *" \
-DRECV_TYPE_ARG3="size_t" \
-DRECV_TYPE_ARG4="int" \
-DHAVE_RECV="1" \
-DSEND_TYPE_ARG1="int" \
-DSEND_TYPE_ARG3="size_t" \
-DSEND_TYPE_ARG4="int" \
-DSEND_QUAL_ARG2="const" \
-DSEND_TYPE_ARG2="void *" \
-DHAVE_SEND="1" \
-DHAVE_MSG_NOSIGNAL="1" \
-DHAVE_ALARM="1" \
-DHAVE_BASENAME="1" \
-DHAVE_CONNECT="1" \
-DHAVE_FCNTL="1" \
-DHAVE_FCNTL_O_NONBLOCK="1" \
-DHAVE_STDIO_H="1" \
-DHAVE_FDOPEN="1" \
-DHAVE_FREEADDRINFO="1" \
-DHAVE_IFADDRS_H="1" \
-DHAVE_SYS_XATTR_H="1" \
-DHAVE_FSETXATTR="1" \
-DHAVE_FSETXATTR_5="1" \
-DHAVE_FTRUNCATE="1" \
-DHAVE_GETADDRINFO="1" \
-DHAVE_GETADDRINFO_THREADSAFE="1" \
-DHAVE_GAI_STRERROR="1" \
-DHAVE_GETHOSTBYADDR="1" \
-DHAVE_GETHOSTBYNAME="1" \
-DHAVE_GETHOSTBYNAME_R="1" \
-DHAVE_GETHOSTBYNAME_R_6="1" \
-DHAVE_GETHOSTNAME="1" \
-DHAVE_GMTIME_R="1" \
-DHAVE_INET_NTOP="1" \
-DHAVE_INET_PTON="1" \
-DHAVE_IOCTL="1" \
-DHAVE_IOCTL_FIONBIO="1" \
-DHAVE_IOCTL_SIOCGIFADDR="1" \
-DHAVE_LOCALTIME_R="1" \
-DHAVE_MEMRCHR="1" \
-DHAVE_POLL="1" \
-DHAVE_POLL_FINE="1" \
-DHAVE_SETSOCKOPT="1" \
-DHAVE_SIGNAL_H="1" \
-DHAVE_SIGACTION="1" \
-DHAVE_SIGINTERRUPT="1" \
-DHAVE_SIGSETJMP="1" \
-DHAVE_SOCKET="1" \
-DHAVE_SOCKETPAIR="1" \
-DHAVE_STRCASECMP="1" \
-DHAVE_STRDUP="1" \
-DHAVE_STRERROR_R="1" \
-DHAVE_POSIX_STRERROR_R="1" \
-DSTRERROR_R_TYPE_ARG3="size_t" \
-DHAVE_STRNCASECMP="1" \
-DHAVE_STRSTR="1" \
-DHAVE_STRTOK_R="1" \
-DHAVE_STRTOLL="1" \
-DHAVE_WRITEV="1" \
-DHAVE_GETEUID="1" \
-DHAVE_GETPPID="1" \
-DHAVE_GETPWUID="1" \
-DHAVE_GETPWUID_R="1" \
-DHAVE_GETRLIMIT="1" \
-DHAVE_GETTIMEOFDAY="1" \
-DHAVE_IF_NAMETOINDEX="1" \
-DHAVE_PIPE="1" \
-DHAVE_SETLOCALE="1" \
-DHAVE_SETRLIMIT="1" \
-DHAVE_UTIME="1" \
-DHAVE_UTIMES="1" \
-DGETNAMEINFO_TYPE_ARG2="socklen_t" \
-DGETNAMEINFO_TYPE_ARG46="size_t" \
-DGETNAMEINFO_TYPE_ARG7="int" \
-DGETNAMEINFO_QUAL_ARG1="const" \
-DGETNAMEINFO_TYPE_ARG1="struct sockaddr *" \
-DHAVE_GETNAMEINFO="1" \
-DENABLE_IPV6="1" \
-DHAVE_PTHREAD_H="1" \
-DUSE_THREADS_POSIX="1" \
-DUSE_UNIX_SOCKETS="1" \
-DCURL_EXTERN_SYMBOL="__attribute__ ((__visibility__ (\"default\")))"

all: $(LIBRARY_NAME)

$(LIBRARY_NAME): $(OBJFILES)
	$(AR) rs $@ $^

%.d:%.cpp
	$(CC) $(CPPFLAGS) $(CFLAGS) -MM -MF $@ $<
    
ifneq ($(MAKECMDGOALS), clean)
-include $(OBJFILES:.o=.d)
endif

clean:
ifeq ($(OS), Windows_NT)
	del $(LIBRARY_NAME) lib\*.o lib\*.d lib\vauth\*.o lib\vauth\*.d lib\vtls\*.o lib\vtls\*.d >nul 2>&1
else
	$(RM) $(LIBRARY_NAME) lib/*.o lib/*.d lib/vauth/*.o lib/vauth/*.d lib/vtls/*.o lib/vtls/*.d
endif

.PHONY: all clean
